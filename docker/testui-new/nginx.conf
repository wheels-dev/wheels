server {
    listen 80;
    server_name localhost;
    root /usr/share/nginx/html;
    index index.html;

    # Enable access and error logging
    access_log /var/log/nginx/testui-access.log;
    error_log /var/log/nginx/testui-error.log debug;

    # Cache static assets
    location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$ {
        expires 30d;
        add_header Cache-Control "public, no-transform";
    }

    # Global proxy settings
    proxy_intercept_errors on;
    
    #####################################################
    # CFML Engine Proxies
    #####################################################
    
    # Proxy configuration for CFML engines
    # These locations allow the TestUI to communicate with the CFML engines

    # Lucee 5
    location /api/lucee5/ {
        # Debug header to identify which engine is being used
        add_header X-CFML-Engine "Lucee 5" always;
        
        # Replace the /api/lucee5/ prefix with / for proxying to the actual engine
        rewrite ^/api/lucee5/(.*) /$1 break;
        
        # Proxy to the Lucee 5 engine container
        proxy_pass http://host.docker.internal:60005/;
        
        # Include common CFML proxy settings
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
        
        # Add debug headers in responses
        add_header X-Proxy-Target "host.docker.internal:60005" always;
        add_header X-Proxy-URI $request_uri always;
        
        # Add long timeouts for test execution
        proxy_read_timeout 600s;
        proxy_connect_timeout 60s;
        proxy_send_timeout 600s;
        
        # Buffer settings for large responses
        proxy_buffer_size 16k;
        proxy_buffers 8 16k;
        proxy_busy_buffers_size 32k;
    }

    # Lucee 6
    location /api/lucee6/ {
        add_header X-CFML-Engine "Lucee 6" always;
        rewrite ^/api/lucee6/(.*) /$1 break;
        proxy_pass http://host.docker.internal:60006/;
        
        # Common settings
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
        add_header X-Proxy-Target "host.docker.internal:60006" always;
        add_header X-Proxy-URI $request_uri always;
        proxy_read_timeout 600s;
        proxy_connect_timeout 60s;
        proxy_send_timeout 600s;
        proxy_buffer_size 16k;
        proxy_buffers 8 16k;
        proxy_busy_buffers_size 32k;
    }

    # Adobe 2018
    location /api/adobe2018/ {
        add_header X-CFML-Engine "Adobe 2018" always;
        rewrite ^/api/adobe2018/(.*) /$1 break;
        proxy_pass http://host.docker.internal:62018/;
        
        # Common settings
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
        add_header X-Proxy-Target "host.docker.internal:62018" always;
        add_header X-Proxy-URI $request_uri always;
        proxy_read_timeout 600s;
        proxy_connect_timeout 60s;
        proxy_send_timeout 600s;
        proxy_buffer_size 16k;
        proxy_buffers 8 16k;
        proxy_busy_buffers_size 32k;
    }

    # Adobe 2021
    location /api/adobe2021/ {
        add_header X-CFML-Engine "Adobe 2021" always;
        rewrite ^/api/adobe2021/(.*) /$1 break;
        proxy_pass http://host.docker.internal:62021/;
        
        # Common settings
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
        add_header X-Proxy-Target "host.docker.internal:62021" always;
        add_header X-Proxy-URI $request_uri always;
        proxy_read_timeout 600s;
        proxy_connect_timeout 60s;
        proxy_send_timeout 600s;
        proxy_buffer_size 16k;
        proxy_buffers 8 16k;
        proxy_busy_buffers_size 32k;
    }

    # Adobe 2023
    location /api/adobe2023/ {
        add_header X-CFML-Engine "Adobe 2023" always;
        rewrite ^/api/adobe2023/(.*) /$1 break;
        proxy_pass http://host.docker.internal:62023/;
        
        # Common settings
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
        add_header X-Proxy-Target "host.docker.internal:62023" always;
        add_header X-Proxy-URI $request_uri always;
        proxy_read_timeout 600s;
        proxy_connect_timeout 60s;
        proxy_send_timeout 600s;
        proxy_buffer_size 16k;
        proxy_buffers 8 16k;
        proxy_busy_buffers_size 32k;
    }

    #####################################################
    # Docker API Integration
    #####################################################
    
    # Docker API connection test endpoint
    location = /api/docker-test {
        add_header Content-Type text/plain;
        return 200 'Docker API test endpoint is working!';
    }
    
    # Docker API connection status endpoint
    location = /api/docker-status {
        default_type application/json;
        
        # Use a shell script to check Docker socket connectivity
        # This avoids needing Lua modules in the container
        proxy_pass http://unix:/var/run/docker.sock:/version;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header Connection "upgrade";
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Content-Type "application/json";
        proxy_set_header Accept "application/json";
        
        # Add debug headers
        add_header X-Debug-DockerAPI "Status Check" always;
    }
    
    # Docker API proxy for container management
    location /api/docker/ {
        # Debug headers to assist with API troubleshooting
        add_header X-Debug-Path $request_uri always;
        add_header X-Debug-Rewrite $uri always;
        
        # Strip /api/docker/ prefix for Docker API requests
        rewrite ^/api/docker/(.*) /$1 break;
        
        # Proxy to the Docker socket
        proxy_pass http://unix:/var/run/docker.sock:;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header Connection "upgrade";
        proxy_set_header Upgrade $http_upgrade;
        proxy_cache_bypass $http_upgrade;
        
        # Set appropriate headers for the Docker API
        proxy_set_header Content-Type "application/json";
        proxy_set_header Accept "application/json";
        
        # Increase proxy timeouts for long-running Docker operations
        proxy_read_timeout 300s;
        proxy_connect_timeout 30s;
        proxy_send_timeout 300s;
    }

    #####################################################
    # Health Check & Misc
    #####################################################
    
    # Docker health check endpoint
    location = /health {
        access_log off;
        add_header Content-Type text/plain;
        return 200 'OK';
    }

    # Show version info
    location = /version {
        add_header Content-Type application/json;
        return 200 '{"version":"1.0.0","name":"CFWheels TestUI","build_date":"2023-05-15"}';
    }

    #####################################################
    # SPA and Error Handling
    #####################################################
    
    # For everything else, serve the SPA (Vue application)
    location / {
        try_files $uri $uri/ /index.html;
        add_header Cache-Control "no-cache, no-store, must-revalidate";
    }

    # Custom error pages
    error_page 404 /index.html;
    error_page 500 502 503 504 /error.html;
}