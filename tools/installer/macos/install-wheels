#!/bin/bash

#
# Wheels macOS Installer - CLI Version
# Version: 1.0.0
#
# This script can be called from the Swift GUI or run directly from command line
#

set -e  # Exit on error
set -u  # Exit on undefined variable

# =============================
# Configuration
# =============================
readonly COMMANDBOX_VERSION="6.2.1"
readonly MINIMUM_JAVA_VERSION=17
readonly WHEELS_CLI_PACKAGE="wheels-cli"
readonly COMMANDBOX_DOWNLOAD_URL="https://downloads.ortussolutions.com/ortussolutions/commandbox/${COMMANDBOX_VERSION}/commandbox-bin-${COMMANDBOX_VERSION}.zip"

# =============================
# Default Values
# =============================
INSTALL_PATH="$HOME/Desktop/commandbox"
APP_NAME="MyWheelsApp"
TEMPLATE="wheels-base-template@^3.0.0"
RELOAD_PASSWORD="changeMe"
DATASOURCE_NAME="MyWheelsApp"
CFML_ENGINE="lucee"
USE_H2=false
USE_BOOTSTRAP=false
INIT_PACKAGE=false
APP_BASE_PATH="$HOME/Desktop/Sites"
FORCE=false
SKIP_PATH=false

TEMP_FILES=()

# =============================
# Temporary installer scripts & status flags
# =============================
TEMP_DIR="${TMPDIR:-/tmp}/wheels-installer"
mkdir -p "$TEMP_DIR"

# Unified installation variables
INSTALL_FLAG="$TEMP_DIR/install-status.txt"
UNIFIED_INSTALL_SCRIPT="$TEMP_DIR/install-dependencies.sh"

# =============================
# Parse Command Line Arguments
# =============================
while [[ $# -gt 0 ]]; do
    case $1 in
        --install-path)
            INSTALL_PATH="$2"
            shift 2
            ;;
        --app-name)
            APP_NAME="$2"
            shift 2
            ;;
        --reload-password)
            RELOAD_PASSWORD="$2"
            shift 2
            ;;
        --datasource-name)
            DATASOURCE_NAME="$2"
            shift 2
            ;;
        --template)
            TEMPLATE="$2"
            shift 2
            ;;
        --engine)
            CFML_ENGINE="$2"
            shift 2
            ;;
        --app-base-path)
            APP_BASE_PATH="$2"
            shift 2
            ;;
        --use-h2)
            USE_H2=true
            shift
            ;;
        --use-bootstrap)
            USE_BOOTSTRAP=true
            shift
            ;;
        --init-package)
            INIT_PACKAGE=true
            shift
            ;;
        --force)
            FORCE=true
            shift
            ;;
        --skip-path)
            SKIP_PATH=true
            shift
            ;;
        *)
            echo "Unknown option: $1"
            exit 1
            ;;
    esac
done

# =============================
# Logging Functions
# =============================

START_TIME=$(date +%s)
mkdir -p "${INSTALL_PATH}/logs"
LOG_FILE="${INSTALL_PATH}/logs/wheels-installation.log"

log_info() {
    echo "[$(date '+%H:%M:%S')] INFO: $1"
    echo "[$(date '+%H:%M:%S')] INFO: $1" >> "$LOG_FILE"
}

log_success() {
    echo "[$(date '+%H:%M:%S')] SUCCESS: $1"
    echo "[$(date '+%H:%M:%S')] SUCCESS: $1" >> "$LOG_FILE"
}

log_error() {
    echo "[$(date '+%H:%M:%S')] ERROR: $1" >&2
    echo "[$(date '+%H:%M:%S')] ERROR: $1" >> "$LOG_FILE"
}

log_section() {
    echo ""
    echo "================================================================================"
    echo "$1"
    echo "================================================================================"
    echo "" >> "$LOG_FILE"
    echo "================================================================================" >> "$LOG_FILE"
    echo "$1" >> "$LOG_FILE"
    echo "================================================================================" >> "$LOG_FILE"
}

# =============================
# Utility Functions
# =============================

add_temp_file() {
    TEMP_FILES+=("$1")
}

cleanup_temp_files() {
    if [[ ${#TEMP_FILES[@]} -gt 0 ]]; then
        for temp_file in "${TEMP_FILES[@]}"; do
            [[ -e "$temp_file" ]] && rm -rf "$temp_file"
        done
    fi
}

stop_with_error() {
    log_error "CRITICAL: $1"
    echo ""
    echo "================================================================================"
    echo "Installation Failed"
    echo "================================================================================"
    echo ""
    echo "Error: $1"
    echo ""
    echo "Need Help?"
    echo "  • Documentation: https://wheels.dev/guides"
    echo "  • Report Issues: https://github.com/wheels-dev/wheels/issues"
    echo "  • Discussion:     https://github.com/wheels-dev/wheels/discussions"
    echo ""
    echo "You can view the installation log here: $LOG_FILE"
    echo ""
    cleanup_temp_files
    exit 1
}

# =============================
# Installation Functions
# =============================

check_existing_installations() {
    log_section "EXISTING INSTALLATIONS CHECK"

    # Check application directory
    local app_path="${APP_BASE_PATH}/${APP_NAME}"
    if [[ -d "$app_path" ]] && ! $FORCE; then
        stop_with_error "Application directory already exists: $app_path"
    fi

    # Check CommandBox servers if CommandBox is installed
    local box_path="${INSTALL_PATH}/box"
    if [[ -f "$box_path" ]] && "$box_path" version &> /dev/null; then
        
        # Check for existing servers with the same name (moved logic)
        local servers_json
        if servers_json=$("$box_path" server list --json 2>/dev/null); then
            if [[ -n "$servers_json" ]]; then
                local existing_server
                existing_server=$(echo "$servers_json" | grep -oi '"name":"'"$APP_NAME"'"' || true)
                
                if [[ -n "$existing_server" ]]; then
                    stop_with_error "A CommandBox server already exists with this name: $APP_NAME"
                fi
            fi
        else
            stop_with_error "Failed to check existing servers Application Name: $APP_NAME"
        fi
    fi
    log_success "No conflicting installations found"
}

check_java() {
    log_section "JAVA VERSION CHECK"

    local java_found=false
    local java_version=0
    local homebrew_needed=false
    local java_needed=false

    # -------------------------------
    # Detect existing Java
    # -------------------------------
    if command -v java &> /dev/null; then
        local java_version_output
        java_version_output=$(java -version 2>&1 | head -n 1)

        if [[ $java_version_output =~ \"([0-9]+)\.([0-9]+) ]]; then
            local major="${BASH_REMATCH[1]}"
            local minor="${BASH_REMATCH[2]}"

            if [[ $major == "1" ]]; then
                java_version=$minor
            else
                java_version=$major
            fi

            java_found=true
            log_info "Found Java version: $java_version"
        fi
    fi

    # -------------------------------
    # Check what needs to be installed
    # -------------------------------
    if [[ $java_found == false ]] || [[ $java_version -lt $MINIMUM_JAVA_VERSION ]]; then
        java_needed=true
        if [[ $java_found == true ]]; then
            log_error "Java version $java_version is below minimum requirement (${MINIMUM_JAVA_VERSION})"
        else
            log_error "Java not found"
        fi
    fi

    if [[ $java_needed == true ]]; then
        log_info "CommandBox requires Java ${MINIMUM_JAVA_VERSION} or higher."

        # Ensure brew path is included for checking
        if [ -d "/opt/homebrew/bin" ]; then
            export PATH="/opt/homebrew/bin:$PATH"
        elif [ -d "/usr/local/bin" ]; then
            export PATH="/usr/local/bin:$PATH"
        fi

        if ! command -v brew &> /dev/null; then
            homebrew_needed=true
            log_error "Homebrew not found"
        else
            log_success "Homebrew detected"
        fi

        # -------------------------------
        # Install dependencies via single terminal session
        # -------------------------------
        install_dependencies_via_terminal "$homebrew_needed" "$java_needed"

        # Wait for installation completion
        while true; do
            if [[ -f "$INSTALL_FLAG" ]]; then
                local result
                result=$(cat "$INSTALL_FLAG")
                if [[ "$result" == "success" ]]; then
                    log_success "Dependencies installed successfully"
                    rm -f "$UNIFIED_INSTALL_SCRIPT" "$INSTALL_FLAG"
                    # Update PATH after successful installation
                    if [ -d "/opt/homebrew/bin" ]; then
                        eval "$(/opt/homebrew/bin/brew shellenv)"
                    elif [ -d "/usr/local/bin" ]; then
                        eval "$(/usr/local/bin/brew shellenv)"
                    fi
                    export PATH="$(brew --prefix openjdk@${MINIMUM_JAVA_VERSION})/bin:$PATH"
                    break
                else
                    stop_with_error "Dependency installation failed"
                fi
            else
                log_info "Waiting for dependency installation……"
            fi
            sleep 2
        done
    else
        log_success "Java version meets requirements (>= ${MINIMUM_JAVA_VERSION})"
    fi
}

install_dependencies_via_terminal() {
    local need_homebrew=$1
    local need_java=$2
    
    log_section "DEPENDENCY INSTALLATION"

    rm -f "$INSTALL_FLAG"

    log_info "Creating unified dependency installer script"

    cat > "$UNIFIED_INSTALL_SCRIPT" <<EOF
#!/bin/bash
clear
echo ""
echo "==============================================="
echo "Wheels Installer – Dependency Setup"
echo "==============================================="
echo ""
echo "This window will install required dependencies."
echo ""

# Status file path
STATUS_FILE="$INSTALL_FLAG"
echo "Status file will be written to: \$STATUS_FILE"
echo ""

EOF

    # Add Homebrew installation if needed
    if [[ "$need_homebrew" == true ]]; then
        cat >> "$UNIFIED_INSTALL_SCRIPT" <<'EOF'
echo "Step 1: Installing Homebrew..."
echo "You may be asked for your macOS password."
echo ""

# Run official Homebrew installer
/bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"

# Add Homebrew to PATH
if [ -d "/opt/homebrew/bin" ]; then
    echo 'eval "$(/opt/homebrew/bin/brew shellenv)"' >> ~/.zprofile
    eval "$(/opt/homebrew/bin/brew shellenv)"
fi

if [ -d "/usr/local/bin" ]; then
    echo 'eval "$(/usr/local/bin/brew shellenv)"' >> ~/.zprofile
    eval "$(/usr/local/bin/brew shellenv)"
fi

# Check if brew installed successfully
if ! command -v brew >/dev/null 2>&1; then
    echo "failed" > "$STATUS_FILE"
    echo ""
    echo "Homebrew installation failed."
    echo "Status file created at: $STATUS_FILE"
    exit 1
fi

echo "Homebrew installed successfully."
echo ""

EOF
    fi

    # Add Java installation if needed
    if [[ "$need_java" == true ]]; then
        cat >> "$UNIFIED_INSTALL_SCRIPT" <<EOF
echo "Step 2: Installing Java ${MINIMUM_JAVA_VERSION}..."
echo ""

# Ensure Homebrew is in PATH
if [ -d "/opt/homebrew/bin" ]; then
    eval "\$(/opt/homebrew/bin/brew shellenv)"
elif [ -d "/usr/local/bin" ]; then
    eval "\$(/usr/local/bin/brew shellenv)"
fi

# Install Java
brew install openjdk@${MINIMUM_JAVA_VERSION}

# Add Java to PATH temporarily
JAVA_PREFIX=\$(brew --prefix openjdk@${MINIMUM_JAVA_VERSION})
export PATH="\$JAVA_PREFIX/bin:\$PATH"

# Add Java to PATH permanently
SHELL_PROFILE="\$HOME/.zprofile"
if ! grep -q "openjdk@${MINIMUM_JAVA_VERSION}/bin" "\$SHELL_PROFILE"; then
    echo "export PATH=\"\$JAVA_PREFIX/bin:\$PATH\"" >> "\$SHELL_PROFILE"
fi

# Verify Java (real JVM check)
if command -v java >/dev/null 2>&1; then
    echo ""
    echo "Java installed successfully."
    echo "Version: \$(java -version 2>&1 | head -n 1)"
else
    echo "failed" > "\$STATUS_FILE"
    echo ""
    echo "Java installation failed."
    echo "Status file created at: \$STATUS_FILE"
    exit 1
fi

EOF
    fi

    # Add completion message to script
    cat >> "$UNIFIED_INSTALL_SCRIPT" <<'EOF'
echo ""
echo "All dependencies installed successfully!"
echo "success" > "$STATUS_FILE"
echo ""
echo "You can now close this Terminal window."
EOF

    chmod +x "$UNIFIED_INSTALL_SCRIPT"
    log_info "Launching Terminal for dependency installation"
    open -a Terminal "$UNIFIED_INSTALL_SCRIPT"
}

install_commandbox() {
    log_section "COMMANDBOX INSTALLATION"

    local box_path="${INSTALL_PATH}/box"

    # Check existing installation
    if [[ -f "$box_path" ]] && ! $FORCE; then
        if "$box_path" version &> /dev/null; then
            log_success "CommandBox already installed"
            return 0
        fi
    fi

    # Create directory
    log_info "Creating installation directory: $INSTALL_PATH"
    mkdir -p "$INSTALL_PATH" || stop_with_error "Failed to create installation directory"

    # Download
    log_info "Downloading CommandBox ${COMMANDBOX_VERSION}..."
    local temp_zip="${TMPDIR}commandbox.zip"
    add_temp_file "$temp_zip"

    if ! curl -L -o "$temp_zip" "$COMMANDBOX_DOWNLOAD_URL" --progress-bar 2>&1; then
        stop_with_error "Failed to download CommandBox"
    fi

    # Extract
    log_info "Extracting CommandBox..."
    if ! unzip -o -q "$temp_zip" -d "$INSTALL_PATH"; then
        stop_with_error "Failed to extract CommandBox"
    fi

    chmod +x "$box_path"
    log_success "CommandBox installed successfully"
}

add_to_path() {
    if $SKIP_PATH; then
        log_info "Skipping PATH update (as requested)"
        return 0
    fi

    # Detect shell and choose appropriate rc file
    local shell_rc
    case "$SHELL" in
        */zsh) 
            shell_rc="$HOME/.zshrc"
            [[ ! -f "$shell_rc" ]] && shell_rc="$HOME/.zprofile" ;;
        */bash) 
            shell_rc="$HOME/.bash_profile"
            [[ ! -f "$shell_rc" ]] && shell_rc="$HOME/.bashrc" ;;
        */fish) 
            shell_rc="$HOME/.config/fish/config.fish" ;;
        *) 
            shell_rc="$HOME/.profile" ;;
    esac

    # Ensure file exists
    mkdir -p "$(dirname "$shell_rc")"
    touch "$shell_rc"

    # Check if path already exists
    if grep -q "export PATH=\"$INSTALL_PATH:\$PATH\"" "$shell_rc" 2>/dev/null; then
        log_success "Already in PATH"
        return 0
    fi

    echo "" >> "$shell_rc"
    echo "# CommandBox (Wheels Installer)" >> "$shell_rc"
    echo "export PATH=\"$INSTALL_PATH:\$PATH\"" >> "$shell_rc"

    export PATH="$INSTALL_PATH:$PATH"
    log_success "Added to PATH"
}

install_wheels_cli() {
    log_section "WHEELS CLI INSTALLATION"

    local box_path="${INSTALL_PATH}/box"

    log_info "Installing Wheels CLI from ForgeBox..."
    if "$box_path" install "$WHEELS_CLI_PACKAGE" --force 2>&1; then
        log_success "Wheels CLI installed"
    else
        log_error "Wheels CLI installation had issues"
    fi
}

create_application() {
    log_section "WHEELS APPLICATION CREATION"

    local box_path="${INSTALL_PATH}/box"
    local app_path="${APP_BASE_PATH}/${APP_NAME}"

    log_info "Checking if server already exists for: $APP_NAME"

    # Check for existing servers with the same name
    local servers_json
    if servers_json=$("$box_path" server list --json 2>/dev/null); then
        
        if [[ -n "$servers_json" ]]; then
            # Parse JSON and check for existing server with same name
            local existing_server
            existing_server=$(echo "$servers_json" | grep -o '"name":"'"$APP_NAME"'"' || true)
            
            if [[ -n "$existing_server" ]]; then
                # Extract server details
                local server_details="Name: $APP_NAME"
                local weburl
                weburl=$(echo "$servers_json" | grep -o '"weburl":"[^"]*"' | head -1 | cut -d'"' -f4 || true)
                local webroot
                webroot=$(echo "$servers_json" | grep -o '"webroot":"[^"]*"' | head -1 | cut -d'"' -f4 || true)
                
                if [[ -n "$weburl" ]]; then
                    server_details+="\nURL: $weburl"
                fi
                if [[ -n "$webroot" ]]; then
                    server_details+="\nWebroot: $webroot"
                fi
                
                stop_with_error "A CommandBox server already exists with this name."
            fi
        fi
    else
        stop_with_error "Failed to check existing servers Application Name: $APP_NAME"
    fi

    log_info "Creating Wheels application: $APP_NAME"
    log_info "Location: $app_path"
    log_info "Template: $TEMPLATE"
    echo ""
    echo "This process may take 2-5 minutes..."
    echo "  - Installing dependencies"
    echo "  - Configuring application"
    echo "  - Setting up development server"
    echo "  Please be patient..."
    echo ""

    mkdir -p "$APP_BASE_PATH"
    cd "$APP_BASE_PATH"

    # Build command
    local cmd=("$box_path" "wheels" "generate" "app" "name=$APP_NAME" "template=$TEMPLATE" "force=true")
    [[ -n "$RELOAD_PASSWORD" ]] && cmd+=("reloadPassword=$RELOAD_PASSWORD")
    [[ "$DATASOURCE_NAME" != "$APP_NAME" ]] && cmd+=("datasourceName=$DATASOURCE_NAME")
    [[ "$CFML_ENGINE" != "lucee" ]] && cmd+=("cfmlEngine=$CFML_ENGINE")
    $USE_H2 && cmd+=("setupH2=true")
    $USE_BOOTSTRAP && cmd+=("useBootstrap=true")
    $INIT_PACKAGE && cmd+=("initPackage=true")

    log_info "Executing: ${cmd[*]}"

    # Capture output to check for specific errors
    local output
    if output=$("${cmd[@]}" 2>&1); then
        log_success "Application created"
        echo "$output"
    else
        echo "$output"

        # Check for version mismatch error
        if echo "$output" | grep -q "Exact version.*not found for package"; then
            echo ""
            echo "================================================================================"
            echo "Package Version Mismatch Detected"
            echo "================================================================================"
            echo ""
            echo "The template you selected has a dependency version mismatch."
            echo ""
            echo "Possible solutions:"
            echo "  1. Try the stable template instead: wheels-base-template@stable"
            echo "  2. Wait a few minutes and try again (ForgeBox may be updating)"
            echo "  3. Report this issue with the template maintainers"
            echo ""
        fi

        stop_with_error "Failed to create application"
    fi
}

show_completion() {
    local duration=$(($(date +%s) - START_TIME))
    local box_path="${INSTALL_PATH}/box"
    local app_path="${APP_BASE_PATH}/${APP_NAME}"

    log_section "INSTALLATION COMPLETE"

    echo ""
    echo "Installation Summary:"
    echo "  - CommandBox: ${INSTALL_PATH}"
    echo "  - Wheels CLI: Installed"
    echo "  - Application: ${APP_BASE_PATH}/${APP_NAME}"

    # Get server URL from running server
    cd "$app_path" 2>/dev/null || true
    local server_url=$("$box_path" server status --json 2>/dev/null | grep -o '"defaultBaseURL":"[^"]*"' | cut -d'"' -f4 || echo "")

    if [[ -n "$server_url" ]]; then
        echo "  - Development Server: ${server_url}"
    fi

    echo ""
    echo "Completed in ${duration} seconds"
    echo ""
    echo "Next Steps:"
    echo "  1. cd ${APP_BASE_PATH}/${APP_NAME}"
    echo "  2. Generate a model:      box wheels generate model User"
    echo "  3. Generate a controller: box wheels generate controller Users"
    echo "  4. Learn more:            https://guides.wheels.dev"
    echo ""
}

# =============================
# Main
# =============================

main() {
    # Initialize
    echo "" > "$LOG_FILE"

    log_section "WHEELS INSTALLER FOR macOS"
    log_info "Version: 1.0.0"
    echo ""

    # Show configuration
    log_info "Configuration:"
    log_info "  CommandBox: $INSTALL_PATH"
    log_info "  Application: $APP_NAME"
    log_info "  Template: $TEMPLATE"
    log_info "  Engine: $CFML_ENGINE"
    log_info "  Location: ${APP_BASE_PATH}/${APP_NAME}"
    echo ""

    # Perform installation
    check_existing_installations
    check_java
    install_commandbox
    add_to_path
    install_wheels_cli
    create_application

    # Cleanup
    cleanup_temp_files

    # Show completion
    show_completion

    exit 0
}

# Error handling
trap 'stop_with_error "Installation interrupted"' INT TERM
trap 'stop_with_error "Unexpected error occurred"' ERR

# Run
main "$@"
