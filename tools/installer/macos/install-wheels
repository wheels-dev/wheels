#!/bin/bash

#
# Wheels macOS Installer - CLI Version
# Version: 1.0.0
#
# This script can be called from the Swift GUI or run directly from command line
#

set -e  # Exit on error
set -u  # Exit on undefined variable

# =============================
# Configuration
# =============================
readonly COMMANDBOX_VERSION="6.2.1"
readonly MINIMUM_JAVA_VERSION=17
readonly WHEELS_CLI_PACKAGE="wheels-cli"
readonly COMMANDBOX_DOWNLOAD_URL="https://downloads.ortussolutions.com/ortussolutions/commandbox/${COMMANDBOX_VERSION}/commandbox-bin-${COMMANDBOX_VERSION}.zip"

# =============================
# Default Values
# =============================
INSTALL_PATH="$HOME/Desktop/commandbox"
APP_NAME="MyWheelsApp"
TEMPLATE="wheels-base-template@BE"
RELOAD_PASSWORD="changeMe"
DATASOURCE_NAME="MyWheelsApp"
CFML_ENGINE="lucee"
USE_H2=false
USE_BOOTSTRAP=false
INIT_PACKAGE=false
APP_BASE_PATH="$HOME/Desktop/Sites"
FORCE=false
SKIP_PATH=false

START_TIME=$(date +%s)
LOG_FILE="${TMPDIR}wheels-installation.log"
TEMP_FILES=()

# =============================
# Parse Command Line Arguments
# =============================
while [[ $# -gt 0 ]]; do
    case $1 in
        --install-path)
            INSTALL_PATH="$2"
            shift 2
            ;;
        --app-name)
            APP_NAME="$2"
            shift 2
            ;;
        --reload-password)
            RELOAD_PASSWORD="$2"
            shift 2
            ;;
        --datasource-name)
            DATASOURCE_NAME="$2"
            shift 2
            ;;
        --template)
            TEMPLATE="$2"
            shift 2
            ;;
        --engine)
            CFML_ENGINE="$2"
            shift 2
            ;;
        --app-base-path)
            APP_BASE_PATH="$2"
            shift 2
            ;;
        --use-h2)
            USE_H2=true
            shift
            ;;
        --use-bootstrap)
            USE_BOOTSTRAP=true
            shift
            ;;
        --init-package)
            INIT_PACKAGE=true
            shift
            ;;
        --force)
            FORCE=true
            shift
            ;;
        --skip-path)
            SKIP_PATH=true
            shift
            ;;
        *)
            echo "Unknown option: $1"
            exit 1
            ;;
    esac
done

# =============================
# Logging Functions
# =============================

log_info() {
    echo "[$(date '+%H:%M:%S')] INFO: $1"
    echo "[$(date '+%H:%M:%S')] INFO: $1" >> "$LOG_FILE"
}

log_success() {
    echo "[$(date '+%H:%M:%S')] SUCCESS: $1"
    echo "[$(date '+%H:%M:%S')] SUCCESS: $1" >> "$LOG_FILE"
}

log_error() {
    echo "[$(date '+%H:%M:%S')] ERROR: $1" >&2
    echo "[$(date '+%H:%M:%S')] ERROR: $1" >> "$LOG_FILE"
}

log_section() {
    echo ""
    echo "================================================================================"
    echo "$1"
    echo "================================================================================"
    echo "" >> "$LOG_FILE"
    echo "================================================================================" >> "$LOG_FILE"
    echo "$1" >> "$LOG_FILE"
    echo "================================================================================" >> "$LOG_FILE"
}

# =============================
# Utility Functions
# =============================

add_temp_file() {
    TEMP_FILES+=("$1")
}

cleanup_temp_files() {
    if [[ ${#TEMP_FILES[@]} -gt 0 ]]; then
        for temp_file in "${TEMP_FILES[@]}"; do
            [[ -e "$temp_file" ]] && rm -rf "$temp_file"
        done
    fi
}

stop_with_error() {
    log_error "CRITICAL: $1"
    echo ""
    echo "================================================================================"
    echo "Installation Failed"
    echo "================================================================================"
    echo ""
    echo "Error: $1"
    echo ""
    echo "Need Help?"
    echo "  • Documentation: https://wheels.dev/guides"
    echo "  • Report Issues: https://github.com/wheels-dev/wheels/issues"
    echo "  • Discussion:     https://github.com/wheels-dev/wheels/discussions"
    echo ""
    echo "Log file saved to: $LOG_FILE"
    echo ""
    cleanup_temp_files
    exit 1
}

# =============================
# Installation Functions
# =============================

check_java() {
    log_section "JAVA VERSION CHECK"

    local java_found=false
    local java_version=0
    local needs_install=false

    # Check if Java is installed
    if command -v java &> /dev/null; then
        # Get Java version
        local java_version_output=$(java -version 2>&1 | head -n 1)

        # Parse version (handles both old format "1.8.0" and new format "17.0.1")
        if [[ $java_version_output =~ \"([0-9]+)\.([0-9]+) ]]; then
            local major="${BASH_REMATCH[1]}"
            local minor="${BASH_REMATCH[2]}"

            # Old format: "1.8.0" means Java 8
            if [[ $major == "1" ]]; then
                java_version=$minor
            else
                # New format: "17.0.1" means Java 17
                java_version=$major
            fi
            java_found=true
            log_info "Found Java version: $java_version"
        fi
    fi

    # Check if Java meets requirements
    if [[ $java_found == false ]] || [[ $java_version -lt $MINIMUM_JAVA_VERSION ]]; then
        needs_install=true

        if [[ $java_found == true ]]; then
            log_error "Java version $java_version is below minimum requirement (${MINIMUM_JAVA_VERSION})"
        else
            log_error "Java not found in PATH"
        fi

        echo ""
        echo "CommandBox requires Java ${MINIMUM_JAVA_VERSION} or higher."
        echo ""

        # Check if Homebrew is available for automatic installation
        if command -v brew &> /dev/null; then
            log_info "Homebrew detected - installing Java ${MINIMUM_JAVA_VERSION} automatically..."
            echo ""

            if brew install openjdk@${MINIMUM_JAVA_VERSION} 2>&1; then
                # Add to PATH for current session
                if [[ -d "/opt/homebrew/opt/openjdk@${MINIMUM_JAVA_VERSION}/bin" ]]; then
                    export PATH="/opt/homebrew/opt/openjdk@${MINIMUM_JAVA_VERSION}/bin:$PATH"
                elif [[ -d "/usr/local/opt/openjdk@${MINIMUM_JAVA_VERSION}/bin" ]]; then
                    export PATH="/usr/local/opt/openjdk@${MINIMUM_JAVA_VERSION}/bin:$PATH"
                fi

                # Verify installation
                if command -v java &> /dev/null; then
                    local new_version_output=$(java -version 2>&1 | head -n 1)
                    log_success "Java ${MINIMUM_JAVA_VERSION} installed successfully"
                    log_info "Version: $new_version_output"
                    echo ""
                    return 0
                else
                    log_error "Java installation completed but 'java' command not found in PATH"
                    stop_with_error "Please restart your terminal and run the installer again"
                fi
            else
                log_error "Failed to install Java via Homebrew"
                stop_with_error "Please install Java manually and try again"
            fi
        else
            # No Homebrew - stop with instructions
            log_error "Homebrew not found - cannot auto-install Java"
            echo ""
            echo "Please install Java ${MINIMUM_JAVA_VERSION} or higher manually:"
            echo ""
            echo "Option 1 - Install Homebrew first (recommended):"
            echo "  /bin/bash -c \"\$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)\""
            echo "  brew install openjdk@${MINIMUM_JAVA_VERSION}"
            echo ""
            echo "Option 2 - Download Java directly:"
            echo "  - Temurin (recommended): https://adoptium.net/temurin/releases/"
            echo "  - Oracle: https://www.oracle.com/java/technologies/downloads/"
            echo ""
            stop_with_error "Java ${MINIMUM_JAVA_VERSION}+ is required"
        fi
    fi

    log_success "Java version meets requirements (>= ${MINIMUM_JAVA_VERSION})"
}

install_commandbox() {
    log_section "COMMANDBOX INSTALLATION"

    local box_path="${INSTALL_PATH}/box"

    # Check existing installation
    if [[ -f "$box_path" ]] && ! $FORCE; then
        if "$box_path" version &> /dev/null; then
            log_success "CommandBox already installed"
            return 0
        fi
    fi

    # Create directory
    log_info "Creating installation directory: $INSTALL_PATH"
    mkdir -p "$INSTALL_PATH" || stop_with_error "Failed to create installation directory"

    # Download
    log_info "Downloading CommandBox ${COMMANDBOX_VERSION}..."
    local temp_zip="${TMPDIR}commandbox.zip"
    add_temp_file "$temp_zip"

    if ! curl -L -o "$temp_zip" "$COMMANDBOX_DOWNLOAD_URL" --progress-bar 2>&1; then
        stop_with_error "Failed to download CommandBox"
    fi

    # Extract
    log_info "Extracting CommandBox..."
    if ! unzip -o -q "$temp_zip" -d "$INSTALL_PATH"; then
        stop_with_error "Failed to extract CommandBox"
    fi

    chmod +x "$box_path"
    log_success "CommandBox installed successfully"
}

add_to_path() {
    if $SKIP_PATH; then
        log_info "Skipping PATH update (as requested)"
        return 0
    fi

    local shell_rc="$HOME/.zshrc"
    [[ "$SHELL" == */bash ]] && shell_rc="$HOME/.bash_profile"

    if grep -q "export PATH=\"$INSTALL_PATH:\$PATH\"" "$shell_rc" 2>/dev/null; then
        log_success "Already in PATH"
        return 0
    fi

    echo "" >> "$shell_rc"
    echo "# CommandBox (Wheels Installer)" >> "$shell_rc"
    echo "export PATH=\"$INSTALL_PATH:\$PATH\"" >> "$shell_rc"

    export PATH="$INSTALL_PATH:$PATH"
    log_success "Added to PATH"
}

install_wheels_cli() {
    log_section "WHEELS CLI INSTALLATION"

    local box_path="${INSTALL_PATH}/box"

    log_info "Installing Wheels CLI from ForgeBox..."
    if "$box_path" install "$WHEELS_CLI_PACKAGE" --force 2>&1; then
        log_success "Wheels CLI installed"
    else
        log_error "Wheels CLI installation had issues"
    fi
}

create_application() {
    log_section "WHEELS APPLICATION CREATION"

    local box_path="${INSTALL_PATH}/box"
    local app_path="${APP_BASE_PATH}/${APP_NAME}"

    log_info "Creating Wheels application: $APP_NAME"
    log_info "Location: $app_path"
    log_info "Template: $TEMPLATE"
    echo ""
    echo "This process may take 2-5 minutes..."
    echo "  - Installing dependencies"
    echo "  - Configuring application"
    echo "  - Setting up development server"
    echo "  Please be patient..."
    echo ""

    # Check existing
    if [[ -d "$app_path" ]]; then
        stop_with_error "Application directory already exists: $app_path"
    fi

    mkdir -p "$APP_BASE_PATH"
    cd "$APP_BASE_PATH"

    # Build command
    local cmd=("$box_path" "wheels" "generate" "app" "name=$APP_NAME" "template=$TEMPLATE" "force=true")
    [[ -n "$RELOAD_PASSWORD" ]] && cmd+=("reloadPassword=$RELOAD_PASSWORD")
    [[ "$DATASOURCE_NAME" != "$APP_NAME" ]] && cmd+=("datasourceName=$DATASOURCE_NAME")
    [[ "$CFML_ENGINE" != "lucee" ]] && cmd+=("cfmlEngine=$CFML_ENGINE")
    $USE_H2 && cmd+=("setupH2=true")
    $USE_BOOTSTRAP && cmd+=("useBootstrap=true")
    $INIT_PACKAGE && cmd+=("initPackage=true")

    log_info "Executing: ${cmd[*]}"

    # Capture output to check for specific errors
    local output
    if output=$("${cmd[@]}" 2>&1); then
        log_success "Application created"
        echo "$output"
    else
        echo "$output"

        # Check for version mismatch error
        if echo "$output" | grep -q "Exact version.*not found for package"; then
            echo ""
            echo "================================================================================"
            echo "Package Version Mismatch Detected"
            echo "================================================================================"
            echo ""
            echo "The template you selected has a dependency version mismatch."
            echo ""
            echo "Possible solutions:"
            echo "  1. Try the stable template instead: wheels-base-template@stable"
            echo "  2. Wait a few minutes and try again (ForgeBox may be updating)"
            echo "  3. Report this issue with the template maintainers"
            echo ""
        fi

        stop_with_error "Failed to create application"
    fi
}

start_server() {
    log_section "DEVELOPMENT SERVER"

    local box_path="${INSTALL_PATH}/box"
    local app_path="${APP_BASE_PATH}/${APP_NAME}"

    cd "$app_path"

    log_info "Starting server..."
    "$box_path" server start 2>&1

    sleep 3

    local server_url=$("$box_path" server status --json 2>/dev/null | grep -o '"defaultBaseURL":"[^"]*"' | cut -d'"' -f4 || echo "")

    if [[ -n "$server_url" ]]; then
        log_success "Server running at: $server_url"
        echo "$server_url" > "${TMPDIR}wheels-server-url.txt"
    fi
}

show_completion() {
    local duration=$(($(date +%s) - START_TIME))
    local box_path="${INSTALL_PATH}/box"
    local app_path="${APP_BASE_PATH}/${APP_NAME}"

    log_section "INSTALLATION COMPLETE"

    echo ""
    echo "Installation Summary:"
    echo "  - CommandBox: ${INSTALL_PATH}"
    echo "  - Wheels CLI: Installed"
    echo "  - Application: ${APP_BASE_PATH}/${APP_NAME}"

    # Get server URL from running server
    cd "$app_path" 2>/dev/null || true
    local server_url=$("$box_path" server status --json 2>/dev/null | grep -o '"defaultBaseURL":"[^"]*"' | cut -d'"' -f4 || echo "")

    if [[ -n "$server_url" ]]; then
        echo "  - Development Server: ${server_url}"
    fi

    echo ""
    echo "Completed in ${duration} seconds"
    echo ""
    echo "Next Steps:"
    echo "  1. cd ${APP_BASE_PATH}/${APP_NAME}"
    echo "  2. Generate a model:      box wheels generate model User"
    echo "  3. Generate a controller: box wheels generate controller Users"
    echo "  4. Learn more:            https://guides.wheels.dev"
    echo ""
}

# =============================
# Main
# =============================

main() {
    # Initialize
    echo "" > "$LOG_FILE"

    log_section "WHEELS INSTALLER FOR macOS"
    log_info "Version: 1.0.0"
    echo ""

    # Show configuration
    log_info "Configuration:"
    log_info "  CommandBox: $INSTALL_PATH"
    log_info "  Application: $APP_NAME"
    log_info "  Template: $TEMPLATE"
    log_info "  Engine: $CFML_ENGINE"
    log_info "  Location: ${APP_BASE_PATH}/${APP_NAME}"
    echo ""

    # Perform installation
    check_java
    install_commandbox
    add_to_path
    install_wheels_cli
    create_application

    # Cleanup
    cleanup_temp_files

    # Show completion
    show_completion

    exit 0
}

# Error handling
trap 'stop_with_error "Installation interrupted"' INT TERM
trap 'stop_with_error "Unexpected error occurred"' ERR

# Run
main "$@"
