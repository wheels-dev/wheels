# This is a reusable workflow that is called from the pr, snapshot, and release workflows
# This workflow runs the complete Wheels Framework Test Suites
name: Wheels Test Suites
# We are a reusable Workflow only
on:
  workflow_call:
    secrets:
      SLACK_WEBHOOK_URL:
        required: true
jobs:
  tests:
    name: Test Suites
    runs-on: ubuntu-latest
    continue-on-error: ${{ matrix.experimental }}
    strategy:
      fail-fast: false
      matrix:
        cfengine:
          ["lucee5", "lucee6", "adobe2018", "adobe2021", "adobe2023"]
        dbengine: ["mysql", "postgres", "sqlserver", "h2", "oracle"]
        commandbox_version: ["6.2.1"]
        jdkVersion: ["21"]
        experimental: [false]
        #include:
          # Lucee 7 experimental tests (non-blocking)
          #- cfengine: "lucee7"
          #  dbengine: "h2"
          #  commandbox_version: "6.2.1"
          #  jdkVersion: "21"
          #  experimental: true
          #- cfengine: "lucee7"
          #  dbengine: "mysql"
          #  commandbox_version: "6.2.1"
          #  jdkVersion: "21"
          #  experimental: true
          #- cfengine: "lucee7"
          #  dbengine: "postgres"
          #  commandbox_version: "6.2.1"
          #  jdkVersion: "21"
          #  experimental: true
          #- cfengine: "lucee7"
          #  dbengine: "sqlserver"
          #  commandbox_version: "6.2.1"
          #  jdkVersion: "21"
          #  experimental: true
          #- cfengine: "lucee7"
          #  dbengine: "oracle"
          #  commandbox_version: "6.2.1"
          #  jdkVersion: "21"
          #  experimental: true
        exclude:
          - cfengine: lucee5
            dbengine: mysql
          - cfengine: lucee5
            dbengine: postgres
          - cfengine: lucee5
            dbengine: sqlserver
          - cfengine: lucee5
            dbengine: h2
          - cfengine: lucee5
            dbengine: oracle
          - cfengine: lucee6
            dbengine: mysql
          - cfengine: lucee6
            dbengine: postgres
          - cfengine: lucee6
            dbengine: sqlserver
          # - cfengine: lucee6
          #   dbengine: h2
          - cfengine: lucee6
            dbengine: oracle
          - cfengine: lucee7
            dbengine: mysql
          - cfengine: lucee7
            dbengine: postgres
          - cfengine: lucee7
            dbengine: sqlserver
          - cfengine: lucee7
            dbengine: h2
          - cfengine: lucee7
            dbengine: oracle
          - cfengine: adobe2018
            dbengine: mysql
          - cfengine: adobe2018
            dbengine: postgres
          - cfengine: adobe2018
            dbengine: sqlserver
          - cfengine: adobe2018
            dbengine: h2
          - cfengine: adobe2018
            dbengine: oracle
          - cfengine: adobe2021
            dbengine: mysql
          - cfengine: adobe2021
            dbengine: postgres
          - cfengine: adobe2021
            dbengine: sqlserver
          - cfengine: adobe2021
            dbengine: h2
          - cfengine: adobe2021
            dbengine: oracle
          - cfengine: adobe2023
            dbengine: mysql
          - cfengine: adobe2023
            dbengine: postgres
          - cfengine: adobe2023
            dbengine: sqlserver
          - cfengine: adobe2023
            dbengine: h2
          - cfengine: adobe2023
            dbengine: oracle
          - cfengine: adobe2025
            dbengine: h2
          - cfengine: adobe2025
            dbengine: oracle
          - cfengine: adobe2025
            dbengine: mysql
          - cfengine: adobe2025
            dbengine: postgres
          - cfengine: adobe2025
            dbengine: sqlserver
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup Environment Variables
        run: |
          pwd
          #tree

      - name: Build up workspace
        run: |
          pwd
          cp -r ./templates/base/src/* ./tools/workspace/
          tree

      - name: Copy server.json files
        run: |
          cp ./tools/docker/${{ matrix.cfengine }}/server.json ./tools/workspace/
          cp ./tools/docker/${{ matrix.cfengine }}/CFConfig-actions.json ./tools/workspace/CFConfig.json
          cp ./tools/docker/${{ matrix.cfengine }}/settings.cfm ./tools/workspace/config/settings.cfm

      - name: Start external DB if needed (${{ matrix.dbengine }}) ...
        if: ${{ matrix.dbengine != 'h2' }}
        run: docker compose up -d ${{ matrix.dbengine }}

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: "temurin"
          java-version: ${{ matrix.jdkVersion }}

      - name: Setup CommandBox CLI
        uses: Ortus-Solutions/setup-commandbox@v2.0.1
        with:
          version: ${{ matrix.commandbox_version }}
          installSystemModules: true
          warmup: true

      - name: Install Dependencies
        run: |
          # Core dependencies
          pwd
          cd ./tools/workspace/
          pwd
          box install

      - name: Start ${{ matrix.cfengine }} Server
        run: |
          cd /home/runner/work/wheels/wheels/
          pwd
          box server start serverConfigFile="server.json" --noSaveSettings --debug

      - name: Running onServerInstall Script for Adobe2021, Adobe2023, and Adobe2025
        if: ${{ matrix.cfengine == 'adobe2021' }} || ${{ matrix.cfengine == 'adobe2023' }} || ${{ matrix.cfengine == 'adobe2025' }}
        run: |
          echo "Running onServerInstall for ${{ matrix.cfengine }}"
          pwd
          cd ./tools/workspace/
          pwd
          box run-script onServerInstall

      - name: Run Tests ${{ matrix.cfengine }} ${{ matrix.dbengine }}
        run: |
          cd /home/runner/work/wheels/wheels/
          pwd
          ./tools/docker/github/core-tests.sh ${{ matrix.cfengine }} ${{ matrix.dbengine }}

      - name: Upload Test Results Artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results-${{ matrix.cfengine }}-${{ matrix.dbengine }}
          path: |
            /tmp/${{ matrix.cfengine }}-${{ matrix.dbengine }}-result.txt

      - name: Failure Debugging Info
        if: ${{ failure() }}
        run: |
          box version
          box server info serverConfigFile="server.json" --json
          box server log serverConfigFile="server.json"

      - name: Upload Workflow Logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: logs-${{ matrix.cfengine }}-${{ matrix.dbengine }}
          path: |
            ${{ runner.temp }}/_runner_diag/
            ${{ runner.temp }}/_github_workflow/
