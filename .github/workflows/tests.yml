# This is a reusable workflow that is called from the pr, snapshot, and release workflows
# This workflow runs the complete Wheels Framework Test Suites
name: Wheels Test Suites
# We are a reusable Workflow only
on:
  workflow_call:
    secrets:
      SLACK_WEBHOOK_URL:
        required: true
jobs:
  tests:
    name: Test Suites
    runs-on: ubuntu-latest
    continue-on-error: ${{ matrix.experimental }}
    strategy:
      fail-fast: false
      matrix:
        cfengine:
          ["lucee@5", "lucee@6", "adobe@2018", "adobe@2021", "adobe@2023"]
        dbengine: ["mysql", "postgres", "sqlserver", "h2", "oracle"]
        commandbox_version: ["6.2.1"]
        jdkVersion: ["21"]
        experimental: [false]
        include:
          # Lucee 7 experimental tests (non-blocking)
          - cfengine: "lucee@7"
            dbengine: "h2"
            commandbox_version: "6.2.1"
            jdkVersion: "21"
            experimental: true
          - cfengine: "lucee@7"
            dbengine: "mysql"
            commandbox_version: "6.2.1"
            jdkVersion: "21"
            experimental: true
          - cfengine: "lucee@7"
            dbengine: "postgres"
            commandbox_version: "6.2.1"
            jdkVersion: "21"
            experimental: true
          - cfengine: "lucee@7"
            dbengine: "sqlserver"
            commandbox_version: "6.2.1"
            jdkVersion: "21"
            experimental: true
          - cfengine: "lucee@7"
            dbengine: "oracle"
            commandbox_version: "6.2.1"
            jdkVersion: "21"
            experimental: true
        exclude:
          # Lucee 5 has compatibility issues with Oracle JDBC driver
          - cfengine: lucee@5
            dbengine: oracle
          # - cfengine: lucee@5
          #   dbengine: mysql
          # - cfengine: lucee@5
          #   dbengine: postgres
          # - cfengine: lucee@5
          #   dbengine: sqlserver
          # - cfengine: lucee@5
          #   dbengine: h2
          # - cfengine: lucee@5
          #   dbengine: oracle
          # - cfengine: lucee@6
          #   dbengine: mysql
          # - cfengine: lucee@6
          #   dbengine: postgres
          # - cfengine: lucee@6
          #   dbengine: sqlserver
          # - cfengine: lucee@6
          #   dbengine: h2
          - cfengine: lucee@6
            dbengine: oracle
          # - cfengine: lucee@7
          #   dbengine: mysql
          # - cfengine: lucee@7
          #   dbengine: postgres
          # - cfengine: lucee@7
          #   dbengine: sqlserver
          # - cfengine: lucee@7
          #   dbengine: h2
          # - cfengine: lucee@7
          #   dbengine: oracle
          # - cfengine: adobe@2018
          #   dbengine: mysql
          # - cfengine: adobe@2018
          #   dbengine: postgres
          # - cfengine: adobe@2018
          #   dbengine: sqlserver
          - cfengine: adobe@2018
            dbengine: h2
          - cfengine: adobe@2018
            dbengine: oracle
          # - cfengine: adobe@2021
          #   dbengine: mysql
          # - cfengine: adobe@2021
          #   dbengine: postgres
          # - cfengine: adobe@2021
          #   dbengine: sqlserver
          - cfengine: adobe@2021
            dbengine: h2
          - cfengine: adobe@2021
            dbengine: oracle
          # - cfengine: adobe@2023
          #   dbengine: mysql
          # - cfengine: adobe@2023
          #   dbengine: postgres
          # - cfengine: adobe@2023
          #   dbengine: sqlserver
          - cfengine: adobe@2023
            dbengine: h2
          - cfengine: adobe@2023
            dbengine: oracle
          - cfengine: adobe@2025
            dbengine: h2
          - cfengine: adobe@2025
            dbengine: oracle
          - cfengine: adobe@2025
            dbengine: mysql
          - cfengine: adobe@2025
            dbengine: postgres
          - cfengine: adobe@2025
            dbengine: sqlserver
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup Test Environment
        run: |
          # Clear and prepare workspace
          rm -rf ./tools/workspace/*

          # Copy base template to workspace root
          cp -r ./templates/base/src/* ./tools/workspace/

          # Copy wheels framework to vendor directory
          mkdir -p ./tools/workspace/vendor
          cp -r ./core/src/wheels ./tools/workspace/vendor/

          # Copy engine-specific configurations
          cp ./tools/docker/${{ matrix.cfengine }}/server.json ./tools/workspace/
          cp ./tools/docker/${{ matrix.cfengine }}/CFConfig-actions.json ./tools/workspace/CFConfig.json
          cp ./tools/docker/${{ matrix.cfengine }}/settings.cfm ./tools/workspace/config/

          # Create H2 database directory if needed
          mkdir -p ./tools/workspace/db/

          # Fix H2 database path in CFConfig to use workspace db directory
          jq '.datasources.wheelstestdb_h2.custom = "mode=MySQL&path=./db/"' ./tools/workspace/CFConfig.json > ./tools/workspace/CFConfig.json.tmp && mv ./tools/workspace/CFConfig.json.tmp ./tools/workspace/CFConfig.json

          # Fix MySQL dbdriver value if it's set to "localhost"
          jq 'if .datasources.wheelstestdb_mysql.dbdriver == "localhost" then .datasources.wheelstestdb_mysql.dbdriver = "mysql" else . end' ./tools/workspace/CFConfig.json > ./tools/workspace/CFConfig.json.tmp && mv ./tools/workspace/CFConfig.json.tmp ./tools/workspace/CFConfig.json

          # Fix Oracle database name and DSN format for Oracle XE
          if jq -e '.datasources.wheelstestdb_oracle' ./tools/workspace/CFConfig.json > /dev/null 2>&1; then
              jq '.datasources.wheelstestdb_oracle.database = "wheelstestdb" | .datasources.wheelstestdb_oracle.dsn = "jdbc:oracle:thin:@{host}:{port}/{database}"' ./tools/workspace/CFConfig.json > ./tools/workspace/CFConfig.json.tmp && mv ./tools/workspace/CFConfig.json.tmp ./tools/workspace/CFConfig.json
          fi

          # Fix server.json libDirs path to be relative to workspace (only for engines that have libDirs)
          if jq -e '.app.libDirs' ./tools/workspace/server.json > /dev/null 2>&1; then
              jq '.app.libDirs = "./lib"' ./tools/workspace/server.json > ./tools/workspace/server.json.tmp && mv ./tools/workspace/server.json.tmp ./tools/workspace/server.json
          fi

          # Create lib directory for database drivers
          mkdir -p ./tools/workspace/lib

          # Download database drivers based on engine and database
          if [[ "${{ matrix.cfengine }}" == lucee* ]]; then
              # Download H2 driver JAR for all Lucee tests (framework may depend on it)
              curl -L -o ./tools/workspace/lib/h2-1.3.172.jar https://repo1.maven.org/maven2/com/h2database/h2/1.3.172/h2-1.3.172.jar
          fi

          # Download Oracle driver if testing with Oracle
          if [[ "${{ matrix.dbengine }}" == "oracle" ]]; then
              # Oracle JDBC driver (using ojdbc8 for compatibility)
              curl -L -o ./tools/workspace/lib/ojdbc8.jar https://repo1.maven.org/maven2/com/oracle/database/jdbc/ojdbc8/19.3.0.0/ojdbc8-19.3.0.0.jar
              # Also download Oracle UCP (connection pooling) which might be required
              curl -L -o ./tools/workspace/lib/ucp.jar https://repo1.maven.org/maven2/com/oracle/database/jdbc/ucp/19.3.0.0/ucp-19.3.0.0.jar
          fi

          # Update settings.cfm for the correct database
          if [ "${{ matrix.dbengine }}" != "h2" ]; then
              sed -i.bak 's/wheelstestdb_h2/wheelstestdb_${{ matrix.dbengine }}/g' ./tools/workspace/config/settings.cfm
          fi

          # Copy test app resources if they don't exist in workspace
          if [ ! -d "./tools/workspace/app" ]; then
              cp -r ./tools/workspace/vendor/wheels/tests_testbox/resources/app ./tools/workspace/
          fi

          # Update box.json with onServerInstall script
          cd ./tools/workspace
          jq '.scripts.onServerInstall = "cfpm install image,mail,zip,debugger,caching,mysql,postgresql,sqlserver"' box.json > box.json.tmp && mv box.json.tmp box.json
          cd ../..

      - name: Start external DB if needed (${{ matrix.dbengine }}) ...
        if: ${{ matrix.dbengine != 'h2' }}
        run: docker compose up -d ${{ matrix.dbengine }}

      - name: Wait for Oracle database to be ready
        if: ${{ matrix.dbengine == 'oracle' }}
        run: |
          echo "Waiting for Oracle database to be ready..."
          for i in {1..30}; do
            if docker compose exec -T oracle sqlplus -S wheelstestdb/wheelstestdb@localhost:1521/wheelstestdb <<< "SELECT 1 FROM DUAL;" 2>/dev/null | grep -q "1"; then
              echo "Oracle is ready!"
              break
            fi
            echo "Waiting for Oracle... ($i/30)"
            sleep 10
          done

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: "temurin"
          java-version: ${{ matrix.jdkVersion }}

      - name: Setup CommandBox CLI
        uses: Ortus-Solutions/setup-commandbox@v2.0.1
        with:
          version: ${{ matrix.commandbox_version }}

      - name: Install Dependencies
        run: |
          # Install dependencies in workspace
          cd ./tools/workspace
          box install

      - name: Start ${{ matrix.cfengine }} Server
        run: |
          cd ./tools/workspace
          box server start serverConfigFile="server.json" --noSaveSettings --debug

      - name: Running onServerInstall Script for Adobe2021, Adobe2023, and Adobe2025
        if: ${{ matrix.cfengine == 'adobe@2021' }} || ${{ matrix.cfengine == 'adobe@2023' }} || ${{ matrix.cfengine == 'adobe@2025' }}
        run: box run-script onServerInstall
        run: |
          cd tools/workspace
          box run-script onServerInstall

      # Database drivers are bundled with CommandBox/Lucee/Adobe CF
      # H2 driver is downloaded manually for Lucee engines in the setup step

      - name: Run Tests ${{ matrix.cfengine }} ${{ matrix.dbengine }}
        run: |
          tools/docker/github/core-tests.sh ${{ matrix.cfengine }} ${{ matrix.dbengine }}

      - name: Upload Test Results Artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results-${{ matrix.cfengine }}-${{ matrix.dbengine }}
          path: |
            /tmp/${{ matrix.cfengine }}-${{ matrix.dbengine }}-result.txt

      - name: Failure Debugging Info
        if: ${{ failure() }}
        run: |
          box version
          cd ./tools/workspace
          box server info serverConfigFile="server.json" --json
          box server log serverConfigFile="server.json"

      - name: Upload Workflow Logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: logs-${{ matrix.cfengine }}-${{ matrix.dbengine }}
          path: |
            ${{ runner.temp }}/_runner_diag/
            ${{ runner.temp }}/_github_workflow/
