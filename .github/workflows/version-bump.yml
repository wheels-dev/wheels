# Version Bump Workflow
# This workflow helps automate version bumping after a release
# It can be manually triggered to update version numbers across all packages

name: Version Bump

on:
  workflow_dispatch:
    inputs:
      new_version:
        description: 'New version number (e.g., 3.0.1-SNAPSHOT or 3.1.0-SNAPSHOT)'
        required: true
        type: string
      bump_type:
        description: 'Type of version bump'
        required: true
        type: choice
        options:
          - patch-snapshot
          - minor-snapshot
          - major-snapshot
        default: patch-snapshot

jobs:
  bump-version:
    name: Bump Version Numbers
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Git
        run: |
          git config user.name "GitHub Actions Bot"
          git config user.email "actions@github.com"

      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Make scripts executable
        run: chmod +x tools/build/scripts/*.sh

      - name: Update Version Numbers
        env:
          NEW_VERSION: ${{ github.event.inputs.new_version }}
        run: |
          echo "Updating to version: $NEW_VERSION"

          # Update templates/base/src/box.json
          jq --arg version "$NEW_VERSION" '.version = $version | .dependencies."wheels-core" = ("^" + $version)' \
            templates/base/src/box.json > templates/base/src/box.json.tmp
          mv templates/base/src/box.json.tmp templates/base/src/box.json

          # Update examples/starter-app/box.json
          jq --arg version "$NEW_VERSION" '.version = $version | .dependencies."wheels-core" = ("^" + $version)' \
            examples/starter-app/box.json > examples/starter-app/box.json.tmp
          mv examples/starter-app/box.json.tmp examples/starter-app/box.json

          echo "Version updated to $NEW_VERSION"

      - name: Generate Changelog from Merged PRs
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          NEW_VERSION: ${{ github.event.inputs.new_version }}
        run: |
          # Strip -SNAPSHOT suffix for changelog header
          CHANGELOG_VERSION="${NEW_VERSION%-SNAPSHOT}"
          ./tools/build/scripts/generate-changelog.sh "$CHANGELOG_VERSION" "" --write

      - name: Commit Changes
        env:
          NEW_VERSION: ${{ github.event.inputs.new_version }}
        run: |
          git add templates/base/src/box.json
          git add examples/starter-app/box.json
          git add CHANGELOG.md

          git commit -m "Bump version to $NEW_VERSION

          Automated version bump and changelog generation using GitHub Actions."

          git push origin main

      - name: Create Summary
        env:
          NEW_VERSION: ${{ github.event.inputs.new_version }}
          BUMP_TYPE: ${{ github.event.inputs.bump_type }}
        run: |
          echo "## Version Bump Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**New Version:** $NEW_VERSION" >> $GITHUB_STEP_SUMMARY
          echo "**Bump Type:** $BUMP_TYPE" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Files Updated:" >> $GITHUB_STEP_SUMMARY
          echo "- templates/base/src/box.json" >> $GITHUB_STEP_SUMMARY
          echo "- examples/starter-app/box.json" >> $GITHUB_STEP_SUMMARY
          echo "- CHANGELOG.md (auto-generated from merged PRs)" >> $GITHUB_STEP_SUMMARY
