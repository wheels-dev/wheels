# Release Candidate Workflow
# This workflow builds and publishes Release Candidates for testing before final releases
# Triggers on release candidate branches (e.g., release/3.0.0-rc.1)

name: Wheels Release Candidate

on:
  push:
    branches:
      - 'release/**-rc.*'

env:
  WHEELS_PRERELEASE: true

jobs:
  #############################################
  # Build & Publish Release Candidate
  #############################################
  build:
    name: Build & Publish Release Candidate
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        id: Checkout-Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Setup Environment Variables For Build Process
        id: Calculate-Version-And-Branch
        run: |
          cd ./templates/base/src
          pwd
          cat box.json

          # Extract version from box.json (should be something like 3.0.0-rc.1)
          VERSION=$(cat box.json | jq '.version' -r)
          echo "WHEELS_VERSION=${VERSION}+${{ github.run_number }}" >> $GITHUB_ENV

          # Extract branch name
          BRANCH="${GITHUB_REF#refs/heads/}"
          echo "BRANCH=${BRANCH}" >> $GITHUB_ENV

          echo "Building Release Candidate: ${VERSION}"
          echo "Branch: ${BRANCH}"

      - name: Make build scripts executable
        run: |
          chmod +x tools/build/scripts/*.sh
          ls -la tools/build/scripts/

      #############################################
      # Validate Release Candidate
      #############################################

      - name: Validate Release Candidate Version
        run: |
          echo "=========================================="
          echo "Validating Release Candidate"
          echo "=========================================="

          # Check that version contains -rc.
          if ! echo "$WHEELS_VERSION" | grep -q "\-rc\."; then
            echo "ERROR: Version must contain '-rc.X' suffix for release candidates"
            echo "Current version: $WHEELS_VERSION"
            exit 1
          fi

          # Check that CHANGELOG contains RC entry
          BASE_VERSION="${WHEELS_VERSION%%+*}"
          if ! grep -q "# \[${BASE_VERSION}\]" CHANGELOG.md; then
            echo "ERROR: CHANGELOG.md must contain entry for ${BASE_VERSION}"
            exit 1
          fi

          echo "✓ Release Candidate validation passed"

      #############################################
      # Prepare and Publish to ForgeBox
      #############################################

      - name: Prepare Wheels Base Template for ForgeBox
        run: |
          ./tools/build/scripts/prepare-base.sh "${{ env.WHEELS_VERSION }}" "${{ env.BRANCH }}" "${{ github.run_number }}" "${{ env.WHEELS_PRERELEASE }}"

      - name: Prepare Wheels Core for ForgeBox
        run: |
          ./tools/build/scripts/prepare-core.sh "${{ env.WHEELS_VERSION }}" "${{ env.BRANCH }}" "${{ github.run_number }}" "${{ env.WHEELS_PRERELEASE }}"

      - name: Prepare Wheels CLI for ForgeBox
        run: |
         ./tools/build/scripts/prepare-cli.sh "${{ env.WHEELS_VERSION }}" "${{ env.BRANCH }}" "${{ github.run_number }}" "${{ env.WHEELS_PRERELEASE }}"

      - name: Prepare Wheels Starter App for ForgeBox
        run: |
         ./tools/build/scripts/prepare-starterApp.sh "${{ env.WHEELS_VERSION }}"

      - name: Install CommandBox
        run: |
          curl -fsSl https://downloads.ortussolutions.com/debs/gpg | sudo gpg --dearmor -o /usr/share/keyrings/ortussolutions.gpg
          echo "deb [signed-by=/usr/share/keyrings/ortussolutions.gpg] https://downloads.ortussolutions.com/debs/noarch /" | sudo tee /etc/apt/sources.list.d/ortussolutions.list
          sudo apt-get update && sudo apt-get install -y commandbox

      #############################################
      # Validate Packages Before Publishing
      #############################################

      - name: Validate Package Structure and Versions
        run: |
          echo "=========================================="
          echo "Validating RC Packages Before ForgeBox Publish"
          echo "=========================================="

          validate_package() {
            local PACKAGE_DIR=$1
            local PACKAGE_NAME=$2

            echo ""
            echo "Validating $PACKAGE_NAME..."

            if [ ! -d "$PACKAGE_DIR" ]; then
              echo "ERROR: Directory $PACKAGE_DIR does not exist!"
              exit 1
            fi

            if [ ! -f "$PACKAGE_DIR/box.json" ]; then
              echo "ERROR: box.json not found in $PACKAGE_DIR!"
              exit 1
            fi

            if ! jq empty "$PACKAGE_DIR/box.json" 2>/dev/null; then
              echo "ERROR: Invalid JSON in $PACKAGE_DIR/box.json"
              exit 1
            fi

            local VERSION=$(jq -r '.version' "$PACKAGE_DIR/box.json")
            echo "  Version: $VERSION"

            if [[ "$VERSION" != "${{ env.WHEELS_VERSION }}" ]]; then
              echo "  WARNING: Version mismatch! Expected ${{ env.WHEELS_VERSION }}, got $VERSION"
            fi

            local FILE_COUNT=$(find "$PACKAGE_DIR" -type f | wc -l)
            echo "  Files: $FILE_COUNT"

            if [ "$FILE_COUNT" -eq 0 ]; then
              echo "ERROR: No files found in package directory!"
              exit 1
            fi

            echo "  ✓ Package validated successfully"
          }

          validate_package "build-wheels-base" "Wheels Base Template"
          validate_package "build-wheels-core/wheels" "Wheels Core"
          validate_package "build-wheels-cli/wheels-cli" "Wheels CLI"
          validate_package "build-wheels-starterApp" "Wheels Starter App"

          echo ""
          echo "=========================================="
          echo "All RC packages validated successfully!"
          echo "=========================================="

      - name: Publish All Packages to ForgeBox
        run: |
          # Publish RC packages and mark as stable so they become the default version
          ./tools/build/scripts/publish-to-forgebox.sh "wheels-dev" "${{ secrets.FORGEBOX_PASS }}" "true" "true"

      #############################################
      # Build Artifacts for GitHub
      #############################################

      - name: Build All Wheels Artifacts
        run: |
          ./tools/build/scripts/build-base.sh "${{ env.WHEELS_VERSION }}" "${{ env.BRANCH }}" "${{ github.run_number }}" "${{ env.WHEELS_PRERELEASE }}"
          ./tools/build/scripts/build-core.sh "${{ env.WHEELS_VERSION }}" "${{ env.BRANCH }}" "${{ github.run_number }}" "${{ env.WHEELS_PRERELEASE }}"
          ./tools/build/scripts/build-cli.sh "${{ env.WHEELS_VERSION }}" "${{ env.BRANCH }}" "${{ github.run_number }}" "${{ env.WHEELS_PRERELEASE }}"
          ./tools/build/scripts/build-starterApp.sh "${{ env.WHEELS_VERSION }}"

      - name: Upload Wheels Base Template Artifact
        uses: actions/upload-artifact@v4
        with:
          name: rc-build-artifacts-base-template
          path: |
            artifacts/wheels/${{ env.WHEELS_VERSION }}/wheels-base-template-*.zip
            artifacts/wheels/${{ env.WHEELS_VERSION }}/wheels-base-template-*.md5
            artifacts/wheels/${{ env.WHEELS_VERSION }}/wheels-base-template-*.sha512

      - name: Upload Wheels Core Artifact
        uses: actions/upload-artifact@v4
        with:
          name: rc-build-artifacts-core
          path: |
            artifacts/wheels/${{ env.WHEELS_VERSION }}/wheels-core-*.zip
            artifacts/wheels/${{ env.WHEELS_VERSION }}/wheels-core-*.md5
            artifacts/wheels/${{ env.WHEELS_VERSION }}/wheels-core-*.sha512

      - name: Upload Wheels CLI Artifact
        uses: actions/upload-artifact@v4
        with:
          name: rc-build-artifacts-cli
          path: |
            artifacts/wheels/${{ env.WHEELS_VERSION }}/wheels-cli-*.zip
            artifacts/wheels/${{ env.WHEELS_VERSION }}/wheels-cli-*.md5
            artifacts/wheels/${{ env.WHEELS_VERSION }}/wheels-cli-*.sha512

      - name: Upload Wheels Starter App Artifact
        uses: actions/upload-artifact@v4
        with:
          name: rc-build-artifacts-starter-app
          path: |
            artifacts/wheels/${{ env.WHEELS_VERSION }}/wheels-starter-app-*.zip
            artifacts/wheels/${{ env.WHEELS_VERSION }}/wheels-starter-app-*.md5
            artifacts/wheels/${{ env.WHEELS_VERSION }}/wheels-starter-app-*.sha512

      - name: Upload All Wheels Artifacts (Combined)
        uses: actions/upload-artifact@v4
        with:
          name: rc-build-artifacts-all
          path: |
            artifacts/**/*

      - name: Upload Workflow Logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: logs-release-candidate
          path: |
            ${{ runner.temp }}/_runner_diag/
            ${{ runner.temp }}/_github_workflow/

      #############################################
      # Create GitHub Prerelease
      #############################################

      - name: Extract Release Notes from CHANGELOG
        id: extract-release-notes
        run: |
          # Extract the RC release notes from CHANGELOG.md
          BASE_VERSION="${WHEELS_VERSION%%+*}"
          awk "/^# \[${BASE_VERSION}\]/,/^---$/ {print}" CHANGELOG.md | sed '1d;$d' > release-notes.md
          echo "Release notes extracted to release-notes.md"
          cat release-notes.md

      - name: Create GitHub Prerelease
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ env.WHEELS_VERSION }}
          name: Wheels ${{ env.WHEELS_VERSION }} (Release Candidate)
          body_path: release-notes.md
          draft: false
          prerelease: true
          files: |
            artifacts/wheels/${{ env.WHEELS_VERSION }}/wheels-base-template-*.zip
            artifacts/wheels/${{ env.WHEELS_VERSION }}/wheels-base-template-*.md5
            artifacts/wheels/${{ env.WHEELS_VERSION }}/wheels-base-template-*.sha512
            artifacts/wheels/${{ env.WHEELS_VERSION }}/wheels-core-*.zip
            artifacts/wheels/${{ env.WHEELS_VERSION }}/wheels-core-*.md5
            artifacts/wheels/${{ env.WHEELS_VERSION }}/wheels-core-*.sha512
            artifacts/wheels/${{ env.WHEELS_VERSION }}/wheels-cli-*.zip
            artifacts/wheels/${{ env.WHEELS_VERSION }}/wheels-cli-*.md5
            artifacts/wheels/${{ env.WHEELS_VERSION }}/wheels-cli-*.sha512
            artifacts/wheels/${{ env.WHEELS_VERSION }}/wheels-starter-app-*.zip
            artifacts/wheels/${{ env.WHEELS_VERSION }}/wheels-starter-app-*.md5
            artifacts/wheels/${{ env.WHEELS_VERSION }}/wheels-starter-app-*.sha512
