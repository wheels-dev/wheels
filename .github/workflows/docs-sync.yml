name: Sync Docs to wheels.dev

on:
  workflow_call:
    secrets:
      WHEELS_DEV_PAT:
        required: true

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout wheels repo
        uses: actions/checkout@v4
        with:
          path: wheels

      - name: Checkout wheels.dev repo
        uses: actions/checkout@v4
        with:
          repository: wheels-dev/wheels.dev
          token: ${{ secrets.WHEELS_DEV_PAT }}
          path: wheels-dev

      - name: Sync docs into wheels.dev
        run: |
          # Guides: mirror with delete
          rsync -av --del wheels/docs/src/ wheels-dev/docs/3.0.0/guides/

          # Images: additive (no delete)
          rsync -av wheels/docs/src/.gitbook/assets/ wheels-dev/public/images/

          # API JSON: mirror with delete
          rsync -av --del wheels/docs/api/ wheels-dev/public/json/

      - name: Commit and push if changed
        working-directory: wheels-dev
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add -A
          if git diff --cached --quiet; then
            echo "No docs changes to sync"
          else
            git commit -m "Sync docs from wheels@${GITHUB_SHA::7}"
            git push
          fi
