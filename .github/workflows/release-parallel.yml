# This workflow is an alternative implementation using parallel builds
# It demonstrates how to build all variants in parallel using matrix strategy
name: Wheels Release (Parallel)

on:
  push:
    branches:
      - main
  workflow_call:
    secrets:
      SLACK_WEBHOOK_URL:
        required: true
      FORGEBOX_API_TOKEN:
        required: true
      FORGEBOX_PASS:
        required: true

env:
  WHEELS_PRERELEASE: false

jobs:
  #############################################
  # Setup Version Information
  #############################################
  setup:
    name: Setup Build Information
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
      branch: ${{ steps.version.outputs.branch }}
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Calculate Version and Branch
        id: version
        run: |
          VERSION=`cat box.json | jq '.version' -r`+${{ github.run_number }}
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          
          if [ $GITHUB_REF == 'refs/heads/develop' ]; then
            echo "branch=develop" >> $GITHUB_OUTPUT
          else
            echo "branch=main" >> $GITHUB_OUTPUT
          fi

  #############################################
  # Build Variants in Parallel
  #############################################
  build:
    name: Build ${{ matrix.variant }} variant
    needs: setup
    runs-on: ubuntu-latest
    strategy:
      matrix:
        variant: [core, base, cli]
        include:
          - variant: core
            slug: wheels-core
            publish_dir: build-wheels-core/wheels
          - variant: base
            slug: wheels-base-template
            publish_dir: build-wheels-base/wheels
          - variant: cli
            slug: wheels-cli
            publish_dir: build-wheels-cli/wheels-cli
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Make build script executable
        run: chmod +x build/scripts/build-${{ matrix.variant }}.sh

      - name: Build ${{ matrix.variant }}
        run: |
          ./build/scripts/build-${{ matrix.variant }}.sh \
            "${{ needs.setup.outputs.version }}" \
            "${{ needs.setup.outputs.branch }}" \
            "${{ github.run_number }}" \
            "${{ env.WHEELS_PRERELEASE }}"

      - name: Upload ${{ matrix.variant }} Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.slug }}
          path: |
            artifacts/wheels/${{ needs.setup.outputs.version }}/${{ matrix.slug }}-*.zip
            artifacts/wheels/${{ needs.setup.outputs.version }}/${{ matrix.slug }}-*.md5
            artifacts/wheels/${{ needs.setup.outputs.version }}/${{ matrix.slug }}-*.sha512
            artifacts/wheels/${{ matrix.slug }}-be.zip

      - name: Publish ${{ matrix.variant }} to ForgeBox
        uses: pixl8/github-action-box-publish@v4
        with:
          forgebox_user: wheels-dev
          forgebox_pass: ${{ secrets.FORGEBOX_PASS }}
          force: "true"
        env:
          BOXJSON_DIR: ${{ matrix.publish_dir }}

  #############################################
  # Combine All Artifacts
  #############################################
  combine-artifacts:
    name: Combine All Artifacts
    needs: [setup, build]
    runs-on: ubuntu-latest
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts-download

      - name: Combine artifacts
        run: |
          mkdir -p artifacts/wheels/${{ needs.setup.outputs.version }}
          mkdir -p artifacts/wheels
          
          # Move all variant artifacts to the correct location
          cp -r artifacts-download/*/* artifacts/wheels/${{ needs.setup.outputs.version }}/ || true
          
          # Move bleeding edge files
          find artifacts-download -name "*-be.zip" -exec cp {} artifacts/wheels/ \;

      - name: Upload Combined Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: wheels-all-variants
          path: |
            artifacts/**/*

#      - name: Post Slack Message
#        id: Post-Slack-Message
#        uses: act10ns/slack@v2
#        with:
#          webhook-url: ${{ secrets.SLACK_WEBHOOK_URL }}
#          status: ${{ job.status }}
#          steps: ${{ toJson(steps) }}
#          channel: '#wheels-dev'
#        if: always()