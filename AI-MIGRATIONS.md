# AI-MIGRATIONS.md

This guide provides comprehensive migration patterns and best practices for AI assistants working with CFWheels migrations.

## Critical Information

**ALWAYS use the CLI to generate migrations. NEVER create migration files manually.**

- **Location**: `app/migrator/migrations/`
- **Naming**: Timestamp-based (e.g., `20231215103045_create_users.cfc`)
- **Generation**: Use `wheels g migration MigrationName`

## CLI Commands for Migrations

### Generating Migrations

```bash
# Create a new table
wheels g migration CreateUsers
wheels g migration CreatePosts
wheels g migration CreateComments

# Add columns to existing table
wheels g migration AddEmailToUsers
wheels g migration AddPublishedAtToPosts

# Remove columns from table
wheels g migration RemovePasswordFromUsers
wheels g migration RemoveStatusFromPosts

# Add indexes
wheels g migration AddIndexToUsersEmail
wheels g migration AddCompoundIndexToPosts

# Other changes
wheels g migration UpdateUserRoles
wheels g migration MigratePostData
```

### Running Migrations

```bash
# Run all pending migrations
wheels db migrate

# Run migrations up to specific version
wheels db migrate to=005

# Rollback last migration
wheels db rollback

# Rollback multiple migrations
wheels db rollback step=3

# Check migration status
wheels db info
```

## Full Migration Patterns

### Create Table Migration

This is the complete pattern generated by the CLI:

```cfml
component extends="wheels.migrator.Migration" hint="Create users table" {

	function up() {
		transaction {
			try {
				t = createTable(name='users', force=false, id=true, primaryKey='id');
				t.string(columnNames='email', limit=255, null=false);
				t.string(columnNames='password', limit=255, null=false);
				t.string(columnNames='firstName,lastName', limit=100, null=true);
				t.string(columnNames='role', limit=50, default='user', null=false);
				t.boolean(columnNames='active', default=true, null=false);
				t.integer(columnNames='loginCount', default=0, null=false);
				t.datetime(columnNames='lastLoginAt', null=true);
				t.timestamps();
				t.create();
				
				// Add indexes after table creation
				addIndex(table='users', columnNames='email', unique=true);
				addIndex(table='users', columnNames='role,active');
			} catch (any e) {
				local.exception = e;
			}

			if (StructKeyExists(local, "exception")) {
				transaction action="rollback";
				Throw(errorCode = "1", detail = local.exception.detail, message = local.exception.message, type = "any");
			} else {
				transaction action="commit";
			}
		}
	}

	function down() {
		transaction {
			try {
				dropTable('users');
			} catch (any e) {
				local.exception = e;
			}

			if (StructKeyExists(local, "exception")) {
				transaction action="rollback";
				Throw(errorCode = "1", detail = local.exception.detail, message = local.exception.message, type = "any");
			} else {
				transaction action="commit";
			}
		}
	}

}
```

### Add Columns Migration

```cfml
component extends="wheels.migrator.Migration" hint="Add profile fields to users" {

	function up() {
		transaction {
			try {
				addColumn(table='users', columnName='bio', columnType='text', null=true);
				addColumn(table='users', columnName='avatarUrl', columnType='string', limit=500, null=true);
				addColumn(table='users', columnName='birthDate', columnType='date', null=true);
			} catch (any e) {
				local.exception = e;
			}

			if (StructKeyExists(local, "exception")) {
				transaction action="rollback";
				Throw(errorCode = "1", detail = local.exception.detail, message = local.exception.message, type = "any");
			} else {
				transaction action="commit";
			}
		}
	}

	function down() {
		transaction {
			try {
				removeColumn(table='users', columnName='bio');
				removeColumn(table='users', columnName='avatarUrl');
				removeColumn(table='users', columnName='birthDate');
			} catch (any e) {
				local.exception = e;
			}

			if (StructKeyExists(local, "exception")) {
				transaction action="rollback";
				Throw(errorCode = "1", detail = local.exception.detail, message = local.exception.message, type = "any");
			} else {
				transaction action="commit";
			}
		}
	}

}
```

### Create Junction Table Migration

```cfml
component extends="wheels.migrator.Migration" hint="Create posts_tags junction table" {

	function up() {
		transaction {
			try {
				t = createTable(name='posts_tags', id=false);
				t.integer(columnNames='postId', null=false);
				t.integer(columnNames='tagId', null=false);
				t.timestamps();
				t.create();
				
				// Add composite primary key
				addIndex(table='posts_tags', columnNames='postId,tagId', unique=true);
				
				// Add foreign key indexes
				addIndex(table='posts_tags', columnNames='postId');
				addIndex(table='posts_tags', columnNames='tagId');
			} catch (any e) {
				local.exception = e;
			}

			if (StructKeyExists(local, "exception")) {
				transaction action="rollback";
				Throw(errorCode = "1", detail = local.exception.detail, message = local.exception.message, type = "any");
			} else {
				transaction action="commit";
			}
		}
	}

	function down() {
		transaction {
			try {
				dropTable('posts_tags');
			} catch (any e) {
				local.exception = e;
			}

			if (StructKeyExists(local, "exception")) {
				transaction action="rollback";
				Throw(errorCode = "1", detail = local.exception.detail, message = local.exception.message, type = "any");
			} else {
				transaction action="commit";
			}
		}
	}

}
```

### Data Migration

```cfml
component extends="wheels.migrator.Migration" hint="Migrate user roles to new format" {

	function up() {
		transaction {
			try {
				// Update existing data
				updateRecords(
					table='users',
					where="role='admin'",
					role='administrator'
				);
				
				updateRecords(
					table='users',
					where="role='mod'",
					role='moderator'
				);
			} catch (any e) {
				local.exception = e;
			}

			if (StructKeyExists(local, "exception")) {
				transaction action="rollback";
				Throw(errorCode = "1", detail = local.exception.detail, message = local.exception.message, type = "any");
			} else {
				transaction action="commit";
			}
		}
	}

	function down() {
		transaction {
			try {
				// Revert data changes
				updateRecords(
					table='users',
					where="role='administrator'",
					role='admin'
				);
				
				updateRecords(
					table='users',
					where="role='moderator'",
					role='mod'
				);
			} catch (any e) {
				local.exception = e;
			}

			if (StructKeyExists(local, "exception")) {
				transaction action="rollback";
				Throw(errorCode = "1", detail = local.exception.detail, message = local.exception.message, type = "any");
			} else {
				transaction action="commit";
			}
		}
	}

}
```

## Column Types Reference

```cfml
// String types
t.string(columnNames='name', limit=255, null=true, default='');
t.text(columnNames='description');
t.char(columnNames='code', limit=10);

// Numeric types
t.integer(columnNames='age', limit=11, null=false, default=0);
t.biginteger(columnNames='views', limit=20);
t.decimal(columnNames='price', precision=10, scale=2);
t.float(columnNames='rating');

// Date/Time types
t.date(columnNames='birthDate');
t.datetime(columnNames='publishedAt');
t.time(columnNames='startTime');
t.timestamps(); // Creates createdAt and updatedAt

// Other types
t.boolean(columnNames='active', default=true);
t.binary(columnNames='data');
t.uniqueidentifier(columnNames='guid');

// Foreign keys
t.references('user'); // Creates userId integer column
```

## Migration Best Practices

### 1. Always Use CLI Generation
```bash
# CORRECT
wheels g migration CreateUsers

# WRONG - Never create files manually
# Don't create files in app/migrator/migrations/ by hand
```

### 2. Test Migrations Thoroughly
- Always test the `up()` method
- Always test the `down()` method
- Ensure rollback works correctly
- Test with actual data

### 3. Handle Existing Data
When modifying columns with existing data:
```cfml
// Add column with default for existing rows
addColumn(
	table='posts',
	columnName='viewCount',
	columnType='integer',
	null=false,
	default=0
);

// Then optionally remove default
changeColumn(
	table='posts',
	columnName='viewCount',
	columnType='integer',
	null=false
);
```

### 4. Use Descriptive Names
```bash
# Good migration names
wheels g migration CreateUsersTable
wheels g migration AddEmailIndexToUsers
wheels g migration RemoveDeprecatedColumnsFromPosts

# Poor migration names
wheels g migration UpdateStuff
wheels g migration Fix
wheels g migration Changes
```

### 5. Keep Migrations Small and Focused
- One logical change per migration
- Easier to debug and rollback
- Better for team collaboration

## Common Pitfalls to Avoid

1. **Don't modify old migrations** - Create new ones instead
2. **Don't use model methods** - Models may change, breaking old migrations
3. **Don't assume database state** - Migrations should be idempotent
4. **Don't forget indexes** - Add indexes for foreign keys and commonly queried columns
5. **Don't skip error handling** - Always use the full try/catch pattern

## Troubleshooting

### Migration Won't Run
```bash
# Check migration status
wheels db info

# Force re-run if needed
wheels db migrate version=0
wheels db migrate
```

### Rollback Issues
```bash
# Rollback to specific version
wheels db rollback to=20231215103045

# If rollback fails, check the down() method
```

### Database Lock Issues
- Ensure no other processes are accessing the database
- Check for long-running queries
- Restart the database if necessary

Remember: The CLI generates the correct structure every time. Always use `wheels g migration` rather than creating files manually.