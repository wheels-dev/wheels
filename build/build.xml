<?xml version="1.0"?>
<!-- ======================================================================
     Wheels Core Build
     ====================================================================== -->
<project name="wheels-core-build" default="build.all" basedir="../">
	<description>
		Build a new distribution of wheels
	</description>

	<!-- UPDATE ON EACH VERSION CYCLE -->
	<property name="groupID"				      value="wheels"/>
	<property name="wheels.slug"	 		    value="wheels"/>
	<property name="wheels.core.slug"	 		value="wheels-core"/>
	<property name="wheels.base.slug"	 		value="wheels-base-template"/>
	<property name="wheels.cli.slug"	 		value="wheels-cli"/>

  <!-- Default environment check, if not passed via -Denvironment -->
	<condition property="environment"       value="local">
		<not><isset property="environment" /></not>
	</condition>

	<!-- Build Labels -->
	<tstamp prefix="start"/>

	<!-- Load Contrib Tasks -->
	<path id="cp">
		<fileset dir="build/lib">
			<include name="**/*.jar" />
		</fileset>
	</path>
	<!-- Define Tasks -->
	<taskdef resource="net/sf/antcontrib/antlib.xml" classpathref="cp" />

	<!-- Init -->
	<target name="init" description="Init the build" unless="src.isInit">
		<if>
			<available file="build/build-${environment}.properties" />
			<then>
				<!-- Load env properties -->
				<echo>Loading properties from environment: ${environment}</echo>
				<loadproperties srcFile="build/build-${environment}.properties"/>
			</then>
		</if>
		<!-- Load root properties -->
		<echo>Loading base properties</echo>
		<loadproperties srcFile="build/build.properties"/>

		<!-- Build Conditions -->
		<condition property="build.branch" else="develop">
			<isset property="build.branch"/>
		</condition>
		<condition property="isPreRelease" else="false">
			<isset property="isPreRelease"/>
		</condition>

		<!-- Build Number -->
		<if>
			<not><isset property="build/build.number" /></not>
			<then>
				<propertyfile file="build/build.number" comment="Build Number for ANT. Edit not!">
					<entry key="build.number"
							type="int"
					     	operation="+"
							pattern="00000"
					     	default="1" />
				</propertyfile>

				<property file="build/build.number"/>
			</then>
		</if>

		<!-- Cleanup exports dir -->
		<delete dir="${dir.exports}" />
		<mkdir dir="${dir.exports}" />

		<!-- Mark as init -->
		<property name="src.isInit" value="true" />
	</target>

	<!-- Build All Releases -->
	<target
		name="build.all"
		description="Builds wheels"
		depends="build.wheels.core,build.wheels.base,build.wheels.cli">
	</target>

  <!-- ================================ -->
	<!-- Build wheels Core Distribution -->
	<target name="build.wheels.core" description="Build a new wheels Core distribution" depends="init">
		<!-- Cleanup + Init -->
		<property name="dir.build.core" value="${basedir}/build-wheels-core"/>
		<delete dir="${dir.build.core}" />
		<mkdir dir="${dir.build.core}" />

		<!-- Init Platform Dirs -->
		<property name="dir.wheels.exports"	value="${dir.exports}/wheels/${wheels.version}" />
		<property name="be.wheels.exports" 	value="${be.exports}/wheels" />

		<property name="build.core.label" value="${wheels.core.slug}-${wheels.version}-${start.DSTAMP}${start.TSTAMP}"/>
		<concat destfile="${dir.build.core}/wheels/${build.core.label}">Built on ${start.TODAY}</concat>

		<copy todir="${dir.build.core}/wheels" encoding="UTF-8" overwrite="true">
			<fileset dir="vendor/wheels">
			<!--	<exclude name="tests/**"/> -->
			</fileset>
		</copy>

		<!-- Copy box.json to exports -->
		<copy file="build/core/box.json" 	toFile="${dir.build.core}/wheels/box.json" 	encoding="UTF-8" overwrite="true"/>
		<copy file="build/core/README.md" toFile="${dir.build.core}/wheels/README.md" 	encoding="UTF-8" overwrite="true"/>

		<!-- Replace Version + Build Numbers -->
		<replaceregexp match='@build.version@' replace="${wheels.version}" flags="ig" byline="true" encoding="UTF-8">
		  <fileset dir="${dir.build.core}/wheels" />
		</replaceregexp>

		<!-- Determine snapshot vs isPrerelease vs master artifact -->
		<if>
			<equals arg1="${isPreRelease}" arg2="true" />
			<then>
				<replaceregexp match='@build.number@' replace="${build.number}" flags="ig" byline="true" encoding="UTF-8">
					<fileset dir="${dir.build.core}/wheels" />
				</replaceregexp>
			</then>

			<elseif>
				<equals arg1="${build.branch}" arg2="develop" />
				<then>
					<replaceregexp match='\+@build.number@' replace="-snapshot" flags="ig" byline="true" encoding="UTF-8">
					  <fileset dir="${dir.build.core}/wheels" />
					</replaceregexp>
				</then>
			</elseif>

			<else>
				<replaceregexp match='@build.number@' replace="${build.number}" flags="ig" byline="true" encoding="UTF-8">
				  <fileset dir="${dir.build.core}/wheels" />
				</replaceregexp>
			</else>
		</if>

		<!-- Zip wheels Bundle -->
		<zip destfile="${dir.wheels.exports}/${wheels.core.slug}-${wheels.version}.zip" basedir="${dir.build.core}/wheels" />

		<!-- Build Checksum -->
		<checksum forceoverwrite="true" fileext=".md5">
			<fileset dir="${dir.wheels.exports}">
				<include name="*.zip" />
			</fileset>
		</checksum>
		<checksum forceoverwrite="true" algorithm="SHA-512" fileext=".sha512">
			<fileset dir="${dir.wheels.exports}">
				<include name="*.zip" />
			</fileset>
		</checksum>

		<!-- Move Bleeding Edge to Root -->
		<copy file="${dir.wheels.exports}/${wheels.core.slug}-${wheels.version}.zip"
			  tofile="${be.wheels.exports}/${wheels.core.slug}-be.zip"
			  overwrite="true"
			  encoding="UTF-8"/>
	</target>
  <!-- ================================ -->

  <!-- ================================ -->
	<!-- Build wheels Base Distribution -->
	<target name="build.wheels.base" description="Build a new wheels Base distribution" depends="init">
		<!-- Cleanup build dir -->
		<property name="dir.build.base" value="${basedir}/build-wheels-base"/>
		<delete dir="${dir.build.base}" />
		<mkdir dir="${dir.build.base}" />

		<!-- Init Platform Dirs -->
		<property name="dir.wheels.exports"	value="${dir.exports}/wheels/${wheels.version}" />
		<property name="be.wheels.exports" 	value="${be.exports}/wheels" />

		<property name="build.base.label" value="${wheels.base.slug}-${wheels.version}-${start.DSTAMP}${start.TSTAMP}"/>
		<concat destfile="${dir.build.base}/wheels/${build.base.label}">Built on ${start.TODAY}</concat>

		<copy todir="${dir.build.base}/wheels" encoding="UTF-8" overwrite="true">
			<fileset dir="${basedir}">
				<include name="app/**"/>
				<include name="public/**"/>
				<include name="tests/**"/>
			</fileset>
		</copy>

		<copy todir="${dir.build.base}/wheels" encoding="UTF-8" overwrite="true">
			<fileset dir="${basedir}/build/base">
				<include name="vendor/**"/>
			</fileset>
		</copy>

		<!-- Copy files to exports -->
		<copy file="build/base/box.json" 	toFile="${dir.build.base}/wheels/box.json" 	encoding="UTF-8" overwrite="true"/>
		<copy file="build/base/README.md" toFile="${dir.build.base}/wheels/README.md" 	encoding="UTF-8" overwrite="true"/>
		<copy file="build/base/server.json" toFile="${dir.build.base}/wheels/server.json" 	encoding="UTF-8" overwrite="true"/>
		<copy file="build/base/app/config/app.cfm" toFile="${dir.build.base}/wheels/app/config/app.cfm" 	encoding="UTF-8" overwrite="true"/>
		<copy file="build/base/app/config/settings.cfm" toFile="${dir.build.base}/wheels/app/config/settings.cfm" 	encoding="UTF-8" overwrite="true"/>

		<!-- Replace Version + Build Numbers -->
		<replaceregexp match='@build.version@' replace="${wheels.version}" flags="ig" byline="true" encoding="UTF-8">
		  <fileset dir="${dir.build.base}/wheels" />
		</replaceregexp>

		<!-- Determine snapshot vs isPrerelease vs master artifact -->
		<if>
			<equals arg1="${isPreRelease}" arg2="true" />
			<then>
				<replaceregexp match='@build.number@' replace="${build.number}" flags="ig" byline="true" encoding="UTF-8">
					<fileset dir="${dir.build.base}/wheels" />
				</replaceregexp>
			</then>

			<elseif>
				<equals arg1="${build.branch}" arg2="develop" />
				<then>
					<replaceregexp match='\+@build.number@' replace="-snapshot" flags="ig" byline="true" encoding="UTF-8">
					  <fileset dir="${dir.build.base}/wheels" />
					</replaceregexp>
				</then>
			</elseif>

			<else>
				<replaceregexp match='@build.number@' replace="${build.number}" flags="ig" byline="true" encoding="UTF-8">
				  <fileset dir="${dir.build.base}/wheels" />
				</replaceregexp>
			</else>
		</if>

		<!-- Zip wheels Bundle -->
		<zip destfile="${dir.wheels.exports}/${wheels.base.slug}-${wheels.version}.zip" basedir="${dir.build.base}/wheels" />

		<!-- Build Checksum -->
		<checksum forceoverwrite="true" fileext=".md5">
			<fileset dir="${dir.wheels.exports}">
				<include name="*.zip" />
			</fileset>
		</checksum>
		<checksum forceoverwrite="true" algorithm="SHA-512" fileext=".sha512">
			<fileset dir="${dir.wheels.exports}">
				<include name="*.zip" />
			</fileset>
		</checksum>

		<!-- Move Bleeding Edge to Root -->
		<copy file="${dir.wheels.exports}/${wheels.base.slug}-${wheels.version}.zip"
			  tofile="${be.wheels.exports}/${wheels.base.slug}-be.zip"
			  overwrite="true"
			  encoding="UTF-8"/>
	</target>
  <!-- ================================ -->

	  <!-- ================================ -->
		<!-- Build wheels CLI Distribution -->
		<target name="build.wheels.cli" description="Build a new wheels CLI distribution" depends="init">
			<!-- Cleanup build dir -->
			<property name="dir.build.cli" value="${basedir}/build-wheels-cli"/>
			<delete dir="${dir.build.cli}" />
			<mkdir dir="${dir.build.cli}" />

			<!-- Init Platform Dirs -->
			<property name="dir.wheels.exports"	value="${dir.exports}/wheels/${wheels.version}" />
			<property name="be.wheels.exports" 	value="${be.exports}/wheels" />

			<property name="build.cli.label" value="${wheels.cli.slug}-${wheels.version}-${start.DSTAMP}${start.TSTAMP}"/>
			<concat destfile="${dir.build.cli}/wheels-cli/${build.cli.label}">Built on ${start.TODAY}</concat>

			<copy todir="${dir.build.cli}/wheels-cli" encoding="UTF-8" overwrite="true">
				<fileset dir="${basedir}/cli">
					<exclude name="workspace/**"/>
					<exclude name="simpletestapp/**"/>
					<exclude name="*.log"/>
					<exclude name=".git/**"/>
					<exclude name=".gitignore"/>
				</fileset>
			</copy>

			<!-- Copy box.json to exports -->
			<copy file="build/cli/box.json" 	toFile="${dir.build.cli}/wheels-cli/box.json" 	encoding="UTF-8" overwrite="true"/>
			<copy file="build/cli/README.md" toFile="${dir.build.cli}/wheels-cli/README.md" 	encoding="UTF-8" overwrite="true"/>

			<!-- Replace Version + Build Numbers -->
			<replaceregexp match='@build.version@' replace="${wheels.version}" flags="ig" byline="true" encoding="UTF-8">
			  <fileset dir="${dir.build.cli}/wheels-cli" />
			</replaceregexp>

			<!-- Determine snapshot vs isPrerelease vs master artifact -->
			<if>
				<equals arg1="${isPreRelease}" arg2="true" />
				<then>
					<replaceregexp match='@build.number@' replace="${build.number}" flags="ig" byline="true" encoding="UTF-8">
						<fileset dir="${dir.build.cli}/wheels-cli" />
					</replaceregexp>
				</then>

				<elseif>
					<equals arg1="${build.branch}" arg2="develop" />
					<then>
						<replaceregexp match='\+@build.number@' replace="-snapshot" flags="ig" byline="true" encoding="UTF-8">
						  <fileset dir="${dir.build.cli}/wheels-cli" />
						</replaceregexp>
					</then>
				</elseif>

				<else>
					<replaceregexp match='@build.number@' replace="${build.number}" flags="ig" byline="true" encoding="UTF-8">
					  <fileset dir="${dir.build.cli}/wheels-cli" />
					</replaceregexp>
				</else>
			</if>

			<!-- Zip wheels CLI Bundle -->
			<zip destfile="${dir.wheels.exports}/${wheels.cli.slug}-${wheels.version}.zip" basedir="${dir.build.cli}/wheels-cli" />

			<!-- Build Checksum -->
			<checksum forceoverwrite="true" fileext=".md5">
				<fileset dir="${dir.wheels.exports}">
					<include name="*.zip" />
				</fileset>
			</checksum>
			<checksum forceoverwrite="true" algorithm="SHA-512" fileext=".sha512">
				<fileset dir="${dir.wheels.exports}">
					<include name="*.zip" />
				</fileset>
			</checksum>

			<!-- Move Bleeding Edge to Root -->
			<copy file="${dir.wheels.exports}/${wheels.cli.slug}-${wheels.version}.zip"
				  tofile="${be.wheels.exports}/${wheels.cli.slug}-be.zip"
				  overwrite="true"
				  encoding="UTF-8"/>
		</target>
	  <!-- ================================ -->

</project>
